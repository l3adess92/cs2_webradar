name: üöÄ Build Windows Application

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    # √âTAPE 1: T√©l√©charger le code
    - name: üì• Download Source Code
      uses: actions/checkout@v4
      with:
        path: source-code  # üëà TOUT va dans ce dossier
    
    # √âTAPE 2: Configurer Visual Studio
    - name: ‚öôÔ∏è Setup Visual Studio 2022
      uses: microsoft/setup-msbuild@v1.3
      
    # √âTAPE 3: Explorer la structure
    - name: üîç Explore Project Structure
      shell: pwsh
      run: |
        Write-Host "=== CURRENT DIRECTORY ==="
        Get-Location
        
        Write-Host "`n=== ALL FILES AND FOLDERS ==="
        Get-ChildItem -Recurse | % { Write-Host "  $($_.FullName)" }
        
        Write-Host "`n=== LOOKING FOR .SLN FILES ==="
        $slnFiles = Get-ChildItem -Recurse -Filter *.sln
        if ($slnFiles.Count -eq 0) {
            Write-Host "‚ùå No .sln files found!"
        } else {
            foreach ($sln in $slnFiles) {
                Write-Host "‚úÖ Found: $($sln.FullName)"
            }
        }
        
    # √âTAPE 4: Trouver le bon chemin
    - name: üó∫Ô∏è Find Correct Build Path
      shell: pwsh
      id: find_path
      run: |
        # Chercher le dossier usermode
        $possiblePaths = @(
            "source-code/usermode",
            "source-code/cs2_webradar/usermode", 
            "usermode",
            "source-code/cs2_webradar-main/usermode"
        )
        
        foreach ($path in $possiblePaths) {
            if (Test-Path $path) {
                Write-Host "‚úÖ Found usermode at: $path"
                Write-Host "::set-output name=usermode_path::$path"
                
                # V√©rifier si .sln existe
                $slnPath = Join-Path $path "cs2_webradar.sln"
                if (Test-Path $slnPath) {
                    Write-Host "‚úÖ .sln exists at: $slnPath"
                    Write-Host "::set-output name=sln_path::$slnPath"
                }
                break
            }
        }
        
    # √âTAPE 5: Compiler le projet
    - name: üî® Compile Project
      shell: pwsh
      run: |
        $usermodePath = "${{ steps.find_path.outputs.usermode_path }}"
        $slnPath = "${{ steps.find_path.outputs.sln_path }}"
        
        Write-Host "Building from: $usermodePath"
        Write-Host "Solution file: $slnPath"
        
        if (-not $slnPath) {
            # Chercher .sln manuellement
            $slnPath = Get-ChildItem -Recurse -Filter *.sln -Path $usermodePath | Select-Object -First 1
            if ($slnPath) {
                Write-Host "Found .sln: $($slnPath.FullName)"
                $slnPath = $slnPath.FullName
            }
        }
        
        if ($slnPath) {
            # Compiler avec MSBuild
            Write-Host "`n=== COMPILING WITH MSBUILD ==="
            msbuild "$slnPath" /p:Configuration=Release /p:Platform=x64 /verbosity:minimal
            
            # Chercher le .exe g√©n√©r√©
            $exeFiles = Get-ChildItem -Recurse -Filter *.exe -Path $usermodePath
            Write-Host "`nFound $($exeFiles.Count) .exe files:"
            foreach ($exe in $exeFiles) {
                Write-Host "  - $($exe.FullName) ($($exe.Length / 1MB) MB)"
            }
        } else {
            Write-Host "‚ùå No .sln file found for compilation!"
            exit 1
        }
        
    # √âTAPE 6: Chercher et copier l'ex√©cutable
    - name: üìÑ Find and Copy Executable
      shell: pwsh
      run: |
        $usermodePath = "${{ steps.find_path.outputs.usermode_path }}"
        
        Write-Host "`n=== SEARCHING FOR .EXE FILES ==="
        
        # Chercher tous les .exe
        $allExeFiles = Get-ChildItem -Recurse -Filter *.exe -Path $usermodePath
        
        if ($allExeFiles.Count -eq 0) {
            Write-Host "‚ùå No .exe files found!"
            Write-Host "`n=== BUILD FAILED - CHECKING FOR ERRORS ==="
            
            # Chercher des fichiers de log d'erreur
            $logFiles = Get-ChildItem -Recurse -Filter *.log -Path $usermodePath
            foreach ($log in $logFiles) {
                Write-Host "`nLog file: $($log.FullName)"
                Get-Content $log.FullName -Tail 20
            }
            
            exit 1
        }
        
        # Prendre le plus gros .exe (probablement le bon)
        $mainExe = $allExeFiles | Sort-Object Length -Descending | Select-Object -First 1
        
        Write-Host "‚úÖ Selected executable:"
        Write-Host "  Name: $($mainExe.Name)"
        Write-Host "  Path: $($mainExe.FullName)"
        Write-Host "  Size: $([math]::Round($mainExe.Length / 1MB, 2)) MB"
        Write-Host "  Date: $($mainExe.CreationTime)"
        
        # Copier vers le dossier racine
        Copy-Item $mainExe.FullName "windows_app.exe" -Force
        
        # V√©rifier la copie
        if (Test-Path "windows_app.exe") {
            $copiedFile = Get-Item "windows_app.exe"
            Write-Host "`n‚úÖ SUCCESS: windows_app.exe created"
            Write-Host "  Size: $([math]::Round($copiedFile.Length / 1MB, 2)) MB"
        } else {
            Write-Host "‚ùå ERROR: Failed to copy executable"
            exit 1
        }
        
    # √âTAPE 7: Pr√©parer les fichiers web
    - name: üåê Prepare Web Application
      shell: pwsh
      run: |
        Write-Host "`n=== PREPARING WEB APP ==="
        
        # Chercher le dossier webapp
        $webappPaths = @(
            "source-code/webapp",
            "source-code/cs2_webradar/webapp",
            "webapp",
            "source-code/cs2_webradar-main/webapp"
        )
        
        $webappFound = $false
        foreach ($path in $webappPaths) {
            if (Test-Path $path) {
                Write-Host "‚úÖ Found webapp at: $path"
                
                # Copier le dossier webapp
                Copy-Item $path "webapp" -Recurse -Force
                $webappFound = $true
                
                # Installer les d√©pendances
                Write-Host "Installing npm dependencies..."
                cd webapp
                npm ci --silent
                cd ..
                
                break
            }
        }
        
        if (-not $webappFound) {
            Write-Host "‚ö†Ô∏è  Webapp not found, but continuing..."
        }
        
    # √âTAPE 8: Cr√©er le package final
    - name: üì¶ Create Final Package
      shell: pwsh
      run: |
        Write-Host "`n=== CREATING FINAL PACKAGE ==="
        
        # Cr√©er dossier de distribution
        New-Item -ItemType Directory -Path "CS2_Radar_Package" -Force
        
        # Copier les fichiers
        if (Test-Path "windows_app.exe") {
            Copy-Item "windows_app.exe" "CS2_Radar_Package/usermode.exe" -Force
            Write-Host "‚úÖ Added: usermode.exe"
        }
        
        if (Test-Path "webapp") {
            Copy-Item "webapp" "CS2_Radar_Package/webapp" -Recurse -Force
            Write-Host "‚úÖ Added: webapp folder"
        }
        
        # Cr√©er le script de lancement
        $launchScript = @'
@echo off
chcp 65001 >nul
echo ========================================
echo        CS2 Web Radar Launcher
echo        Educational Use Only
echo ========================================
echo.
echo [1/3] Starting web server...
cd /d "%~dp0webapp"
start "Web Server" cmd /c "npm start"
timeout /t 5 /nobreak >nul

echo [2/3] Starting radar...
cd /d "%~dp0"
if exist "usermode.exe" (
    start "Radar" usermode.exe
) else (
    echo ERROR: usermode.exe not found!
)

echo [3/3] Opening browser...
start http://localhost:5173
echo.
echo ========================================
echo INSTRUCTIONS:
echo 1. Launch CS2 with: -insecure -novid
echo 2. Add bots: bot_add ct, bot_add t
echo 3. Radar will appear in browser
echo ========================================
echo.
pause
'@
        
        $launchScript | Out-File -FilePath "CS2_Radar_Package/START.bat" -Encoding ASCII
        Write-Host "‚úÖ Added: START.bat launcher"
        
        # Cr√©er README
        $readme = @'
# CS2 Web Radar Package

## Contents:
- usermode.exe - Memory reader application
- webapp/ - Web interface (localhost:5173)
- START.bat - Launch everything automatically

## Usage:
1. Run START.bat
2. Launch Counter-Strike 2 with these launch options:
   -insecure -novid +sv_cheats 1 +map de_dust2
3. In CS2 console (~), type: bot_add ct, bot_add t
4. Open browser to: http://localhost:5173

## Important:
- ONLY use with -insecure parameter
- For educational/testing purposes only
- May trigger antivirus (false positive)
'@
        
        $readme | Out-File -FilePath "CS2_Radar_Package/README.txt" -Encoding ASCII
        Write-Host "‚úÖ Added: README.txt"
        
        # Cr√©er le ZIP
        Write-Host "`nCreating ZIP package..."
        7z a -tzip "CS2_Radar_Complete.zip" "CS2_Radar_Package\*"
        
        $zipSize = (Get-Item "CS2_Radar_Complete.zip").Length / 1MB
        Write-Host "‚úÖ Package created: CS2_Radar_Complete.zip ($([math]::Round($zipSize, 2)) MB)"
        
    # √âTAPE 9: T√©l√©verser les artefacts
    - name: ‚¨ÜÔ∏è Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CS2-Radar-Complete-Package
        path: |
          CS2_Radar_Complete.zip
          windows_app.exe
        retention-days: 7
        
    # √âTAPE 10: Rapport de succ√®s
    - name: üéâ Build Success
      if: success()
      shell: pwsh
      run: |
        Write-Host "`n"
        Write-Host "############################################"
        Write-Host "#                                          #"
        Write-Host "#     üéâ BUILD SUCCESSFULLY COMPLETED     #"
        Write-Host "#                                          #"
        Write-Host "############################################"
        Write-Host "`n"
        Write-Host "üì¶ Artifact: CS2-Radar-Complete-Package"
        Write-Host "üìÅ Contains: usermode.exe + webapp + launcher"
        Write-Host "‚è±Ô∏è  Status: Ready for download"
        Write-Host "`nNext steps:"
        Write-Host "1. Download the artifact"
        Write-Host "2. Extract to C:\CS2_Radar\"
        Write-Host "3. Run START.bat"
        Write-Host "4. Launch CS2 with -insecure flag"
