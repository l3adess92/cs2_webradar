name: üöÄ Build CS2 Radar

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    # √âTAPE 1: T√©l√©charger le code
    - name: üì• Download Code
      uses: actions/checkout@v4
      
    # √âTAPE 2: Explorer pour comprendre la structure
    - name: üîç Debug - Show Structure
      shell: cmd
      run: |
        echo === DEBUG: SHOWING ALL FILES ===
        dir /s /b
        echo.
        echo === DEBUG: LOOKING FOR .SLN FILES ===
        dir *.sln /s /b
        
    # √âTAPE 3: Compiler AVANT de chercher le .exe
    - name: üî® Compile Project
      shell: cmd
      run: |
        echo === COMPILATION START ===
        
        # Essayer diff√©rents chemins
        if exist "cs2_webradar\cs2_webradar.sln" (
            echo "Found solution in cs2_webradar\cs2_webradar.sln"
            cd cs2_webradar
            msbuild cs2_webradar.sln /p:Configuration=Release
        ) else if exist "usermode\cs2_webradar.sln" (
            echo "Found solution in usermode\cs2_webradar.sln"
            cd usermode
            msbuild cs2_webradar.sln /p:Configuration=Release
        ) else (
            echo "ERROR: No .sln file found!"
            dir *.sln /s /b
            exit 1
        )
        
    # √âTAPE 4: CHERCHER LE .exe APR√àS compilation (m√©thode intelligente)
    - name: üîé Find Generated Executable
      shell: cmd
      run: |
        echo === SEARCHING FOR .EXE ===
        
        # Option 1: Chercher r√©cursivement
        for /r %%i in (cs2_webradar.exe) do (
            echo "Found: %%i"
            copy "%%i" "radar_final.exe"
            goto :exe_found
        )
        
        # Option 2: Chercher dans les dossiers Release
        if exist "x64\Release\cs2_webradar.exe" (
            copy "x64\Release\cs2_webradar.exe" "radar_final.exe"
            goto :exe_found
        )
        
        if exist "Release\cs2_webradar.exe" (
            copy "Release\cs2_webradar.exe" "radar_final.exe"
            goto :exe_found
        )
        
        # Option 3: Chercher n'importe quel .exe r√©cent
        echo "Looking for ANY .exe file..."
        for /r %%i in (*.exe) do (
            echo "Possible: %%i"
            copy "%%i" "radar_final.exe"
            goto :exe_found
        )
        
        echo "‚ùå ERROR: No .exe file found after compilation!"
        echo "Debug: Listing all .exe files..."
        dir *.exe /s /b
        exit 1
        
        :exe_found
        echo "‚úÖ EXE COPIED: radar_final.exe"
        
    # √âTAPE 5: Pr√©parer webapp SANS npm install (on le fera plus tard)
    - name: üåê Copy WebApp
      shell: cmd
      run: |
        echo === COPYING WEBAPP ===
        
        if exist "..\webapp" (
            xcopy "..\webapp" "webapp" /E /I /Y
            echo "Webapp copied from parent"
        ) else if exist "webapp" (
            echo "Webapp already here"
        ) else if exist "..\..\webapp" (
            xcopy "..\..\webapp" "webapp" /E /I /Y
            echo "Webapp copied from grandparent"
        ) else (
            echo "‚ö†Ô∏è  Webapp not found"
        )
        
    # √âTAPE 6: Cr√©er ZIP SANS se baser sur des chemins fixes
    - name: üì¶ Create Final Package
      shell: cmd
      run: |
        echo === CREATING FINAL PACKAGE ===
        
        mkdir FINAL_PACKAGE
        
        # Copier l'exe si trouv√©
        if exist "radar_final.exe" (
            copy "radar_final.exe" "FINAL_PACKAGE\usermode.exe"
            echo "‚úÖ Added usermode.exe"
        )
        
        # Copier webapp si trouv√©
        if exist "webapp" (
            xcopy "webapp" "FINAL_PACKAGE\webapp" /E /I /Y
            echo "‚úÖ Added webapp"
        )
        
        # Cr√©er un script de lancement simple
        echo @echo off > "FINAL_PACKAGE\START.bat"
        echo echo CS2 Radar >> "FINAL_PACKAGE\START.bat"
        echo cd /d "%%~dp0" >> "FINAL_PACKAGE\START.bat"
        echo if exist "usermode.exe" ( >> "FINAL_PACKAGE\START.bat"
        echo   echo Starting usermode.exe >> "FINAL_PACKAGE\START.bat"
        echo   start usermode.exe >> "FINAL_PACKAGE\START.bat"
        echo ) >> "FINAL_PACKAGE\START.bat"
        echo if exist "webapp" ( >> "FINAL_PACKAGE\START.bat"
        echo   cd webapp >> "FINAL_PACKAGE\START.bat"
        echo   echo Starting web server... >> "FINAL_PACKAGE\START.bat"
        echo   start /b npm start >> "FINAL_PACKAGE\START.bat"
        echo   cd .. >> "FINAL_PACKAGE\START.bat"
        echo ) >> "FINAL_PACKAGE\START.bat"
        echo timeout /t 3 >> "FINAL_PACKAGE\START.bat"
        echo start http://localhost:5173 >> "FINAL_PACKAGE\START.bat"
        echo pause >> "FINAL_PACKAGE\START.bat"
        echo "‚úÖ Added START.bat"
        
        # ZIP
        "C:\Program Files\7-Zip\7z.exe" a final_package.zip FINAL_PACKAGE\*
        
        echo.
        echo "‚úÖ PACKAGE CREATED: final_package.zip"
        
    # √âTAPE 7: Upload
    - name: ‚¨ÜÔ∏è Upload Result
      uses: actions/upload-artifact@v4
      with:
        name: cs2-radar-package
        path: final_package.zip
